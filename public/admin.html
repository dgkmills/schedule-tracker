<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Tracker - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 100;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 101;
        }
        .modal-backdrop.active, .modal.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-900">T. Dan's Action Lab - Admin Dashboard</h1>
            <a href="/index.html" class="text-indigo-600 hover:text-indigo-800 transition">‚Üê Back to Welcome Page</a>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div id="loading-state" class="text-center py-12">
            <p class="text-lg text-gray-600">Connecting to the database...</p>
        </div>

        <div id="app-content" class="hidden">
            <!-- Grid Layout -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                <!-- Students Column -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Students</h2>
                        <div>
                             <button id="export-students-csv-btn" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition shadow-sm mr-2">Export Students</button>
                            <button id="add-student-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition shadow-sm">Add Student</button>
                        </div>
                    </div>
                    <div id="student-list" class="space-y-3">
                        <!-- Student items will be injected here by JavaScript -->
                    </div>
                </div>

                <!-- Classes Column -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Upcoming Classes</h2>
                        <div>
                            <button id="export-classes-csv-btn" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition shadow-sm mr-2">Export Classes</button>
                            <button id="add-class-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition shadow-sm">Schedule Class</button>
                        </div>
                    </div>
                    <div id="class-list" class="space-y-3">
                        <!-- Class items will be injected here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="modal-backdrop" class="modal-backdrop"></div>

    <!-- Add Student Modal -->
    <div id="add-student-modal" class="modal bg-white w-full max-w-md p-6 rounded-lg shadow-xl">
        <h3 class="text-lg font-medium mb-4">Add New Student</h3>
        <form id="add-student-form">
            <input type="text" id="student-name-input" placeholder="Student Name" class="w-full border-gray-300 rounded-md shadow-sm mb-4" required>
             <input type="number" id="student-bundle-input" placeholder="Initial Bundle Classes (e.g., 10)" class="w-full border-gray-300 rounded-md shadow-sm mb-4" required>
            <div class="flex justify-end space-x-2">
                <button type="button" class="modal-cancel-btn bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Save Student</button>
            </div>
        </form>
    </div>

    <!-- Add Class Modal -->
    <div id="add-class-modal" class="modal bg-white w-full max-w-md p-6 rounded-lg shadow-xl">
        <h3 class="text-lg font-medium mb-4">Schedule New Class</h3>
        <form id="add-class-form">
            <div class="mb-4">
                <label for="class-type-select" class="block text-sm font-medium text-gray-700">Class Type</label>
                <select id="class-type-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option value="group">Group Class</option>
                    <option value="private">Private Class</option>
                </select>
            </div>
            <input type="date" id="class-date-input" class="w-full border-gray-300 rounded-md shadow-sm mb-2" required>
            <input type="text" id="class-time-input" placeholder="e.g., 10:00 AM - 11:00 AM" class="w-full border-gray-300 rounded-md shadow-sm mb-4" required>
            <div class="flex justify-end space-x-2">
                <button type="button" class="modal-cancel-btn bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Class</button>
            </div>
        </form>
    </div>
    
    <!-- Attendance Modal -->
    <div id="attendance-modal" class="modal bg-white w-full max-w-lg p-6 rounded-lg shadow-xl">
        <h3 class="text-lg font-medium mb-1">Manage Attendance</h3>
        <p id="attendance-modal-header" class="text-sm text-gray-500 mb-4"></p>
        <div id="attendance-student-list" class="space-y-3 max-h-80 overflow-y-auto pr-2">
            <!-- Attendance checklist will be injected here -->
        </div>
        <div class="flex justify-end space-x-2 mt-6">
            <button type="button" class="modal-cancel-btn bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
            <button id="save-attendance-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Save Attendance</button>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal bg-white w-full max-w-sm p-6 rounded-lg shadow-xl text-center">
        <h3 class="text-lg font-medium mb-4">Are you sure?</h3>
        <p id="confirmation-message" class="text-gray-600 mb-6"></p>
        <div class="flex justify-center space-x-4">
            <button id="confirm-cancel-btn" class="bg-gray-200 px-6 py-2 rounded-md hover:bg-gray-300">Cancel</button>
            <button id="confirm-action-btn" class="bg-red-600 text-white px-6 py-2 rounded-md hover:bg-red-700">Delete</button>
        </div>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        // IMPORTANT: This configuration is copied from your index.html to ensure
        // this admin panel connects to the SAME database as your public website.
        const firebaseConfig = {
          apiKey: "AIzaSyAdkkonrM6gFCN_xmw5g1qSJipHJ_LZKTE",
          authDomain: "schedule.dgkmills.com",
          projectId: "dgkmills-schedule-tracker",
          storageBucket: "dgkmills-schedule-tracker.appspot.com",
          messagingSenderId: "1078055932000",
          appId: "1:1078055932000:web:cba2d49fb42eaf319fb305",
          measurementId: "G-QJ1JM61WK3"
        };
        
        const appId = 'dgkmills-schedule-tracker';

        // --- Pricing Configuration ---
        const prices = {
            groupBundle: 425,
            groupNoBundle: 500,
            private: 650
        };

        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, getDoc,
            query, orderBy, deleteDoc, writeBatch
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Collection References ---
        const studentsCol = collection(db, `artifacts/${appId}/public/data/students`);
        const classesCol = collection(db, `artifacts/${appId}/public/data/classes`);

        // --- DOM Elements ---
        const studentListEl = document.getElementById('student-list');
        const classListEl = document.getElementById('class-list');
        const loadingStateEl = document.getElementById('loading-state');
        const appContentEl = document.getElementById('app-content');

        let allStudents = [];
        let allClasses = [];

        // --- Modal Handling ---
        const backdrop = document.getElementById('modal-backdrop');
        const modals = {
            addStudent: document.getElementById('add-student-modal'),
            addClass: document.getElementById('add-class-modal'),
            attendance: document.getElementById('attendance-modal'),
            confirmation: document.getElementById('confirmation-modal'),
        };
        
        let confirmationCallback = null;

        function openModal(modalName) {
            backdrop.classList.add('active');
            modals[modalName].classList.add('active');
        }

        function closeModal() {
            backdrop.classList.remove('active');
            Object.values(modals).forEach(modal => modal.classList.remove('active'));
            confirmationCallback = null;
        }
        
        function openConfirmationModal(message, onConfirm) {
            document.getElementById('confirmation-message').textContent = message;
            confirmationCallback = onConfirm;
            openModal('confirmation');
        }

        document.getElementById('add-student-btn').addEventListener('click', () => openModal('addStudent'));
        document.getElementById('add-class-btn').addEventListener('click', () => openModal('addClass'));
        backdrop.addEventListener('click', closeModal);
        document.querySelectorAll('.modal-cancel-btn, #confirm-cancel-btn').forEach(btn => btn.addEventListener('click', closeModal));
        document.getElementById('confirm-action-btn').addEventListener('click', () => {
            if (typeof confirmationCallback === 'function') {
                confirmationCallback();
            }
            closeModal();
        });

        // --- Firestore Data Rendering ---

        function renderStudents(students) {
            allStudents = students;
            studentListEl.innerHTML = '';
            if (students.length === 0) {
                 studentListEl.innerHTML = `<p class="text-gray-500">No students added yet.</p>`;
                 return;
            }
            students.sort((a,b) => a.name.localeCompare(b.name)).forEach(student => {
                const classesLeft = student.bundleClassesRemaining || 0;
                const bundleColor = classesLeft > 3 ? 'text-green-600' : (classesLeft > 0 ? 'text-yellow-600' : 'text-red-600');
                
                const studentDiv = document.createElement('div');
                studentDiv.className = 'p-3 border rounded-md flex justify-between items-center';
                studentDiv.innerHTML = `
                    <div>
                        <p class="font-medium">${student.name}</p>
                        <p class="text-sm ${bundleColor}">Bundle Classes: ${classesLeft}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button data-id="${student.id}" class="add-bundle-btn bg-blue-100 text-blue-800 text-xs font-medium px-3 py-1 rounded-full hover:bg-blue-200">Add 10 Classes</button>
                        <button data-id="${student.id}" data-name="${student.name}" class="delete-student-btn bg-red-100 text-red-800 text-xs font-medium px-3 py-1 rounded-full hover:bg-red-200">Delete</button>
                    </div>
                `;
                studentListEl.appendChild(studentDiv);
            });
        }

        function renderClasses(classes) {
            allClasses = classes; // Update cache for exporting
            classListEl.innerHTML = '';
            if (classes.length === 0) {
                 classListEl.innerHTML = `<p class="text-gray-500">No classes scheduled.</p>`;
                 return;
            }
            classes.forEach(cls => {
                const classDate = dayjs(cls.date).format('dddd, MMMM D, YYYY');
                const classTypeDisplay = cls.classType === 'private' ? 'Private Class' : 'Group Class';
                const classTypeColor = cls.classType === 'private' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800';

                // Calculate gross sales
                let grossSales = 0;
                if(cls.attendees && Array.isArray(cls.attendees)){
                    cls.attendees.forEach(attendee => {
                        if(attendee.paymentMethod === 'groupBundle') grossSales += prices.groupBundle;
                        else if(attendee.paymentMethod === 'groupNoBundle') grossSales += prices.groupNoBundle;
                        else if(attendee.paymentMethod === 'private') grossSales += prices.private;
                    });
                }
                
                const classDiv = document.createElement('div');
                classDiv.className = 'p-3 border rounded-md';
                classDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-medium">${classDate}</p>
                            <p class="text-sm text-gray-600">Time: ${cls.time}</p>
                             <div class="flex items-center mt-1">
                                <span class="text-sm text-gray-600 mr-2">Attendees: ${cls.attendees ? cls.attendees.length : 0}</span>
                                <span class="text-sm font-semibold text-blue-700">Gross Sales: ${grossSales.toLocaleString()} baht</span>
                            </div>
                        </div>
                        <div class="text-right">
                             <div class="flex items-center justify-end space-x-2 mb-2">
                                <span class="text-xs font-semibold px-2 py-1 rounded-full ${classTypeColor}">${classTypeDisplay}</span>
                                <button data-id="${cls.id}" data-date="${classDate}" class="delete-class-btn bg-red-600 text-white text-sm px-3 py-1 rounded-md hover:bg-red-700">Delete</button>
                            </div>
                            <button data-id="${cls.id}" data-date="${classDate}" data-time="${cls.time}" data-type="${cls.classType || 'group'}" class="manage-attendance-btn bg-gray-600 text-white text-sm px-3 py-2 rounded-md hover:bg-gray-700 w-full">Manage Attendance</button>
                        </div>
                    </div>
                `;
                classListEl.appendChild(classDiv);
            });
        }


        // --- Firestore Real-time Listeners ---
        function setupListeners() {
            onSnapshot(studentsCol, (querySnapshot) => {
                const students = [];
                querySnapshot.forEach((doc) => students.push({ id: doc.id, ...doc.data() }));
                renderStudents(students);
                loadingStateEl.style.display = 'none';
                appContentEl.classList.remove('hidden');
            }, (error) => {
                console.error("Error fetching students:", error);
                loadingStateEl.innerHTML = `<p class="text-red-500">Error: Could not connect to the database.</p>`;
            });

            const classesQuery = query(classesCol, orderBy("date", "desc"));
            onSnapshot(classesQuery, (querySnapshot) => {
                const classes = [];
                querySnapshot.forEach((doc) => classes.push({ id: doc.id, ...doc.data() }));
                renderClasses(classes);
            });
        }


        // --- Firestore Write Operations ---

        document.getElementById('add-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentName = document.getElementById('student-name-input').value.trim();
            const bundleSize = parseInt(document.getElementById('student-bundle-input').value, 10) || 0;
            if (studentName) {
                try {
                    await addDoc(studentsCol, {
                        name: studentName,
                        bundleClassesRemaining: bundleSize
                    });
                    document.getElementById('add-student-form').reset();
                    closeModal();
                } catch (error) {
                    console.error("Error adding student: ", error);
                    alert("Could not add student.");
                }
            }
        });
        
        document.getElementById('add-class-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const classDate = document.getElementById('class-date-input').value;
            const classTime = document.getElementById('class-time-input').value.trim();
            const classType = document.getElementById('class-type-select').value;
            if (classDate && classTime) {
                 try {
                    await addDoc(classesCol, {
                        date: classDate,
                        time: classTime,
                        classType: classType,
                        attendees: []
                    });
                    document.getElementById('add-class-form').reset();
                    closeModal();
                } catch (error) {
                    console.error("Error adding class: ", error);
                    alert("Could not add class.");
                }
            }
        });

        studentListEl.addEventListener('click', async (e) => {
            const target = e.target;
            if (target.closest('.add-bundle-btn')) {
                const studentId = target.closest('.add-bundle-btn').dataset.id;
                const studentRef = doc(db, studentsCol.path, studentId);
                try {
                    const studentDoc = await getDoc(studentRef);
                    const currentBundles = studentDoc.data().bundleClassesRemaining || 0;
                    await updateDoc(studentRef, { bundleClassesRemaining: currentBundles + 10 });
                } catch (error) {
                    console.error("Error adding bundle:", error);
                    alert("Could not add bundle.");
                }
            }
            if (target.closest('.delete-student-btn')) {
                 const button = target.closest('.delete-student-btn');
                 const studentId = button.dataset.id;
                 const studentName = button.dataset.name;
                 openConfirmationModal(`This will permanently delete ${studentName}.`, async () => {
                     try {
                        await deleteDoc(doc(db, studentsCol.path, studentId));
                     } catch (error) {
                         console.error("Error deleting student:", error);
                         alert("Could not delete student.");
                     }
                 });
            }
        });

        const attendanceListEl = document.getElementById('attendance-student-list');
        const attendanceModalHeader = document.getElementById('attendance-modal-header');
        let currentClassId = null;

        classListEl.addEventListener('click', async (e) => {
            const target = e.target;
            if (target.closest('.manage-attendance-btn')) {
                const button = target.closest('.manage-attendance-btn');
                currentClassId = button.dataset.id;
                attendanceModalHeader.textContent = `${button.dataset.date} at ${button.dataset.time}`;
                const classType = button.dataset.type;

                const classRef = doc(db, classesCol.path, currentClassId);
                const classDoc = await getDoc(classRef);
                const currentAttendees = classDoc.data().attendees || [];
                
                attendanceListEl.innerHTML = ''; 
                allStudents.sort((a,b) => a.name.localeCompare(b.name)).forEach(student => {
                    const attendanceRecord = currentAttendees.find(a => a.studentId === student.id);
                    const paymentMethod = attendanceRecord ? attendanceRecord.paymentMethod : '';

                    const hasBundle = (student.bundleClassesRemaining || 0) > 0;
                    const bundleInfo = hasBundle ? `(${student.bundleClassesRemaining} left)` : '(No Bundle)';
                    
                    const disabledPrivate = classType === 'group' ? 'disabled' : '';
                    const disabledGroup = classType === 'private' ? 'disabled' : '';
                    const disabledBundle = classType === 'private' || !hasBundle ? 'disabled' : '';

                    const row = document.createElement('div');
                    row.className = 'p-3 border rounded-md';
                    row.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-medium">${student.name}</p>
                                <p class="text-sm text-gray-500">${bundleInfo}</p>
                            </div>
                            <div class="flex space-x-2" data-student-id="${student.id}">
                                <input type="radio" name="payment-${student.id}" value="groupBundle" id="bundle-${student.id}" ${paymentMethod === 'groupBundle' ? 'checked' : ''} ${disabledBundle}>
                                <label for="bundle-${student.id}" class="${disabledBundle ? 'text-gray-400' : ''}">Bundle</label>
                                
                                <input type="radio" name="payment-${student.id}" value="groupNoBundle" id="no-bundle-${student.id}" ${paymentMethod === 'groupNoBundle' ? 'checked' : ''} ${disabledGroup}>
                                <label for="no-bundle-${student.id}" class="${disabledGroup ? 'text-gray-400' : ''}">No Bundle</label>

                                <input type="radio" name="payment-${student.id}" value="private" id="private-${student.id}" ${paymentMethod === 'private' ? 'checked' : ''} ${disabledPrivate}>
                                <label for="private-${student.id}" class="${disabledPrivate ? 'text-gray-400' : ''}">Private</label>
                            </div>
                        </div>
                    `;
                    attendanceListEl.appendChild(row);
                });

                openModal('attendance');
            }
            
            if (target.closest('.delete-class-btn')) {
                const button = target.closest('.delete-class-btn');
                openConfirmationModal(`This will delete the class on ${button.dataset.date} and refund any used bundle credits.`, async () => {
                     const classRef = doc(db, classesCol.path, button.dataset.id);
                     try {
                        const classDoc = await getDoc(classRef);
                        if (!classDoc.exists()) return;

                        const attendees = classDoc.data().attendees || [];
                        const batch = writeBatch(db);

                        if (attendees.length > 0) {
                           const bundledAttendees = attendees.filter(a => a.paymentMethod === 'groupBundle');
                           for (const attendee of bundledAttendees) {
                                const studentRef = doc(db, studentsCol.path, attendee.studentId);
                                const student = allStudents.find(s => s.id === attendee.studentId);
                                if (student) {
                                    batch.update(studentRef, { bundleClassesRemaining: (student.bundleClassesRemaining || 0) + 1 });
                                }
                           }
                        }
                        
                        batch.delete(classRef);
                        await batch.commit();

                     } catch (error) {
                         console.error("Error deleting class:", error);
                         alert("Could not delete class.");
                     }
                 });
            }
        });
        
        document.getElementById('save-attendance-btn').addEventListener('click', async () => {
            if (!currentClassId) return;
            
            const newAttendees = [];
            const studentRows = attendanceListEl.querySelectorAll('[data-student-id]');
            studentRows.forEach(row => {
                const checkedRadio = row.querySelector('input[type="radio"]:checked');
                if(checkedRadio){
                    newAttendees.push({
                        studentId: row.dataset.studentId,
                        paymentMethod: checkedRadio.value
                    });
                }
            });
            
            try {
                const classRef = doc(db, classesCol.path, currentClassId);
                const classDoc = await getDoc(classRef);
                const previousAttendees = classDoc.data().attendees || [];
                const batch = writeBatch(db);

                batch.update(classRef, { attendees: newAttendees });

                // Compare previous and new state to adjust bundles
                allStudents.forEach(student => {
                    const prevRecord = previousAttendees.find(a => a.studentId === student.id);
                    const newRecord = newAttendees.find(a => a.studentId === student.id);

                    const wasBundle = prevRecord && prevRecord.paymentMethod === 'groupBundle';
                    const isBundle = newRecord && newRecord.paymentMethod === 'groupBundle';

                    if (wasBundle === isBundle) return; // No change needed

                    const studentRef = doc(db, studentsCol.path, student.id);
                    const classesRemaining = student.bundleClassesRemaining || 0;
                    
                    if (!wasBundle && isBundle) { // Just used a bundle
                        batch.update(studentRef, { bundleClassesRemaining: classesRemaining - 1 });
                    }
                    else if (wasBundle && !isBundle) { // Refund a bundle
                         batch.update(studentRef, { bundleClassesRemaining: classesRemaining + 1 });
                    }
                });
                
                await batch.commit();
                closeModal();

            } catch (error) {
                console.error("Error saving attendance: ", error);
                alert("Could not save attendance.");
            }
        });

        // --- CSV Export Logic ---
        document.getElementById('export-students-csv-btn').addEventListener('click', () => {
            if (allStudents.length === 0) {
                alert("No student data to export.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Student Name,Remaining Bundle Classes\r\n";

            allStudents.sort((a,b) => a.name.localeCompare(b.name)).forEach(student => {
                const row = `"${student.name}",${student.bundleClassesRemaining || 0}`;
                csvContent += row + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const formattedDate = dayjs().format('YYYY-MM-DD');
            link.setAttribute("download", `student_export_${formattedDate}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        document.getElementById('export-classes-csv-btn').addEventListener('click', () => {
            if (allClasses.length === 0) {
                alert("No class data to export.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Class Date,Class Time,Class Type,Student Name,Payment Method,Amount Paid (baht)\r\n";

            const sortedClasses = [...allClasses].sort((a, b) => new Date(a.date) - new Date(b.date));

            sortedClasses.forEach(cls => {
                if (cls.attendees && cls.attendees.length > 0) {
                    // Sort attendees alphabetically for consistent export order
                    const sortedAttendees = [...cls.attendees].sort((a, b) => {
                        const studentA = allStudents.find(s => s.id === a.studentId);
                        const studentB = allStudents.find(s => s.id === b.studentId);
                        if(studentA && studentB) return studentA.name.localeCompare(studentB.name);
                        return 0;
                    });

                    sortedAttendees.forEach(attendee => {
                        const student = allStudents.find(s => s.id === attendee.studentId);
                        const studentName = student ? student.name : 'Unknown Student';
                        
                        let paymentMethodDisplay = '';
                        let amountPaid = 0;

                        switch (attendee.paymentMethod) {
                            case 'groupBundle':
                                paymentMethodDisplay = 'Bundle';
                                amountPaid = prices.groupBundle;
                                break;
                            case 'groupNoBundle':
                                paymentMethodDisplay = 'No Bundle';
                                amountPaid = prices.groupNoBundle;
                                break;
                            case 'private':
                                paymentMethodDisplay = 'Private';
                                amountPaid = prices.private;
                                break;
                            default:
                                paymentMethodDisplay = 'N/A';
                        }
                        
                        const classTypeDisplay = cls.classType === 'private' ? 'Private' : 'Group';
                        
                        const row = [
                            `"${dayjs(cls.date).format('YYYY-MM-DD')}"`,
                            `"${cls.time}"`,
                            `"${classTypeDisplay}"`,
                            `"${studentName}"`,
                            `"${paymentMethodDisplay}"`,
                            amountPaid
                        ].join(',');
                        
                        csvContent += row + "\r\n";
                    });
                }
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const formattedDate = dayjs().format('YYYY-MM-DD');
            link.setAttribute("download", `class_export_${formattedDate}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // --- Initial Load ---
        setupListeners();

    </script>
</body>
</html>

