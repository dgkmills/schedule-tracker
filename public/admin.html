<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Tracker - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 100;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 101;
        }
        .modal-backdrop.active, .modal.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-900">T. Dan's Action Lab - Admin Dashboard</h1>
            <a href="/index.html" class="text-indigo-600 hover:text-indigo-800 transition">‚Üê Back to Welcome Page</a>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div id="loading-state" class="text-center py-12">
            <p class="text-lg text-gray-600">Connecting to the database...</p>
        </div>

        <div id="app-content" class="hidden">
            <!-- Grid Layout -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                <!-- Students Column -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Students</h2>
                        <div>
                             <button id="export-csv-btn" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition shadow-sm mr-2">Export to CSV</button>
                            <button id="add-student-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition shadow-sm">Add Student</button>
                        </div>
                    </div>
                    <div id="student-list" class="space-y-3">
                        <!-- Student items will be injected here by JavaScript -->
                    </div>
                </div>

                <!-- Classes Column -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Upcoming Classes</h2>
                        <button id="add-class-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition shadow-sm">Schedule Class</button>
                    </div>
                    <div id="class-list" class="space-y-3">
                        <!-- Class items will be injected here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="modal-backdrop" class="modal-backdrop"></div>

    <!-- Add Student Modal -->
    <div id="add-student-modal" class="modal bg-white w-full max-w-md p-6 rounded-lg shadow-xl">
        <h3 class="text-lg font-medium mb-4">Add New Student</h3>
        <form id="add-student-form">
            <input type="text" id="student-name-input" placeholder="Student Name" class="w-full border-gray-300 rounded-md shadow-sm mb-4" required>
             <input type="number" id="student-bundle-input" placeholder="Initial Bundle Classes (e.g., 10)" class="w-full border-gray-300 rounded-md shadow-sm mb-4" required>
            <div class="flex justify-end space-x-2">
                <button type="button" class="modal-cancel-btn bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Save Student</button>
            </div>
        </form>
    </div>

    <!-- Add Class Modal -->
    <div id="add-class-modal" class="modal bg-white w-full max-w-md p-6 rounded-lg shadow-xl">
        <h3 class="text-lg font-medium mb-4">Schedule New Class</h3>
        <form id="add-class-form">
            <input type="date" id="class-date-input" class="w-full border-gray-300 rounded-md shadow-sm mb-2" required>
            <input type="text" id="class-time-input" placeholder="e.g., 10:00 AM - 11:00 AM" class="w-full border-gray-300 rounded-md shadow-sm mb-4" required>
            <div class="flex justify-end space-x-2">
                <button type="button" class="modal-cancel-btn bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Save Class</button>
            </div>
        </form>
    </div>
    
    <!-- Attendance Modal -->
    <div id="attendance-modal" class="modal bg-white w-full max-w-lg p-6 rounded-lg shadow-xl">
        <h3 class="text-lg font-medium mb-1">Manage Attendance</h3>
        <p id="attendance-modal-header" class="text-sm text-gray-500 mb-4"></p>
        <div id="attendance-student-list" class="space-y-2 max-h-80 overflow-y-auto pr-2">
            <!-- Attendance checklist will be injected here -->
        </div>
        <div class="flex justify-end space-x-2 mt-4">
            <button type="button" class="modal-cancel-btn bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
            <button id="save-attendance-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Save Attendance</button>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal bg-white w-full max-w-sm p-6 rounded-lg shadow-xl text-center">
        <h3 class="text-lg font-medium mb-4">Are you sure?</h3>
        <p id="confirmation-message" class="text-gray-600 mb-6"></p>
        <div class="flex justify-center space-x-4">
            <button id="confirm-cancel-btn" class="bg-gray-200 px-6 py-2 rounded-md hover:bg-gray-300">Cancel</button>
            <button id="confirm-action-btn" class="bg-red-600 text-white px-6 py-2 rounded-md hover:bg-red-700">Delete</button>
        </div>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        // IMPORTANT: This configuration is copied from your index.html to ensure
        // this admin panel connects to the SAME database as your public website.
        const firebaseConfig = {
          apiKey: "AIzaSyAdkkonrM6gFCN_xmw5g1qSJipHJ_LZKTE",
          authDomain: "schedule.dgkmills.com",
          projectId: "dgkmills-schedule-tracker",
          storageBucket: "dgkmills-schedule-tracker.appspot.com",
          messagingSenderId: "1078055932000",
          appId: "1:1078055932000:web:cba2d49fb42eaf319fb305",
          measurementId: "G-QJ1JM61WK3"
        };
        
        // This ID should match the one used in your index.html to ensure data is read from the correct place
        const appId = 'dgkmills-schedule-tracker';

        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, getDoc,
            query, orderBy, where, getDocs, writeBatch, deleteDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Collection References ---
        // These paths are updated to match the data structure from your index.html
        const studentsCol = collection(db, `artifacts/${appId}/public/data/students`);
        const classesCol = collection(db, `artifacts/${appId}/public/data/classes`);


        // --- DOM Elements ---
        const studentListEl = document.getElementById('student-list');
        const classListEl = document.getElementById('class-list');
        const loadingStateEl = document.getElementById('loading-state');
        const appContentEl = document.getElementById('app-content');

        let allStudents = []; // Cache for all students

        // --- Modal Handling ---
        const backdrop = document.getElementById('modal-backdrop');
        const modals = {
            addStudent: document.getElementById('add-student-modal'),
            addClass: document.getElementById('add-class-modal'),
            attendance: document.getElementById('attendance-modal'),
            confirmation: document.getElementById('confirmation-modal'),
        };
        
        let confirmationCallback = null;

        function openModal(modalName) {
            backdrop.classList.add('active');
            modals[modalName].classList.add('active');
        }

        function closeModal() {
            backdrop.classList.remove('active');
            Object.values(modals).forEach(modal => modal.classList.remove('active'));
            confirmationCallback = null; // Reset callback
        }
        
        function openConfirmationModal(message, onConfirm) {
            document.getElementById('confirmation-message').textContent = message;
            confirmationCallback = onConfirm;
            openModal('confirmation');
        }

        document.getElementById('add-student-btn').addEventListener('click', () => openModal('addStudent'));
        document.getElementById('add-class-btn').addEventListener('click', () => openModal('addClass'));
        backdrop.addEventListener('click', closeModal);
        document.querySelectorAll('.modal-cancel-btn, #confirm-cancel-btn').forEach(btn => btn.addEventListener('click', closeModal));
        document.getElementById('confirm-action-btn').addEventListener('click', () => {
            if (typeof confirmationCallback === 'function') {
                confirmationCallback();
            }
            closeModal();
        });


        // --- Firestore Data Rendering ---

        // Render All Students
        function renderStudents(students) {
            allStudents = students; // Update cache
            studentListEl.innerHTML = '';
            if (students.length === 0) {
                 studentListEl.innerHTML = `<p class="text-gray-500">No students added yet.</p>`;
                 return;
            }
            students.sort((a,b) => a.name.localeCompare(b.name)).forEach(student => {
                const classesLeft = student.bundleClassesRemaining || 0;
                const bundleColor = classesLeft > 3 ? 'text-green-600' : (classesLeft > 0 ? 'text-yellow-600' : 'text-red-600');
                
                const studentDiv = document.createElement('div');
                studentDiv.className = 'p-3 border rounded-md flex justify-between items-center';
                studentDiv.innerHTML = `
                    <div>
                        <p class="font-medium">${student.name}</p>
                        <p class="text-sm ${bundleColor}">Bundle Classes: ${classesLeft}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button data-id="${student.id}" class="add-bundle-btn bg-blue-100 text-blue-800 text-xs font-medium px-3 py-1 rounded-full hover:bg-blue-200">Add 10 Classes</button>
                        <button data-id="${student.id}" data-name="${student.name}" class="delete-student-btn bg-red-100 text-red-800 text-xs font-medium px-3 py-1 rounded-full hover:bg-red-200">Delete</button>
                    </div>
                `;
                studentListEl.appendChild(studentDiv);
            });
        }

        // Render All Classes
        function renderClasses(classes) {
            classListEl.innerHTML = '';
            if (classes.length === 0) {
                 classListEl.innerHTML = `<p class="text-gray-500">No classes scheduled.</p>`;
                 return;
            }
            classes.forEach(cls => {
                const classDate = dayjs(cls.date).format('dddd, MMMM D, YYYY');
                const classDiv = document.createElement('div');
                classDiv.className = 'p-3 border rounded-md';
                classDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-medium">${classDate}</p>
                            <p class="text-sm text-gray-600">Time: ${cls.time}</p>
                            <p class="text-sm text-gray-600">Attendees: ${cls.attendees ? cls.attendees.length : 0}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button data-id="${cls.id}" data-date="${classDate}" data-time="${cls.time}" class="manage-attendance-btn bg-gray-600 text-white text-sm px-3 py-1 rounded-md hover:bg-gray-700">Manage Attendance</button>
                            <button data-id="${cls.id}" data-date="${classDate}" class="delete-class-btn bg-red-600 text-white text-sm px-3 py-1 rounded-md hover:bg-red-700">Delete</button>
                        </div>
                    </div>
                `;
                classListEl.appendChild(classDiv);
            });
        }


        // --- Firestore Real-time Listeners ---
        function setupListeners() {
            // Students listener
            onSnapshot(studentsCol, (querySnapshot) => {
                const students = [];
                querySnapshot.forEach((doc) => {
                    students.push({ id: doc.id, ...doc.data() });
                });
                renderStudents(students);
                loadingStateEl.style.display = 'none';
                appContentEl.classList.remove('hidden');
            }, (error) => {
                console.error("Error fetching students:", error);
                loadingStateEl.innerHTML = `<p class="text-red-500">Error connecting to the database. Make sure your Firebase config is correct and Firestore is enabled.</p>`;
            });

            // Classes listener
            const classesQuery = query(classesCol, orderBy("date", "desc"));
            onSnapshot(classesQuery, (querySnapshot) => {
                const classes = [];
                querySnapshot.forEach((doc) => {
                    classes.push({ id: doc.id, ...doc.data() });
                });
                renderClasses(classes);
            });
        }


        // --- Firestore Write Operations ---

        // Add a new student
        document.getElementById('add-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentName = document.getElementById('student-name-input').value.trim();
            const bundleSize = parseInt(document.getElementById('student-bundle-input').value, 10) || 0;
            if (studentName) {
                try {
                    await addDoc(studentsCol, {
                        name: studentName,
                        bundleClassesRemaining: bundleSize
                    });
                    document.getElementById('add-student-form').reset();
                    closeModal();
                } catch (error) {
                    console.error("Error adding student: ", error);
                    alert("Could not add student. Check console for errors.");
                }
            }
        });
        
        // Add a new class
        document.getElementById('add-class-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const classDate = document.getElementById('class-date-input').value;
            const classTime = document.getElementById('class-time-input').value.trim();
            if (classDate && classTime) {
                 try {
                    await addDoc(classesCol, {
                        date: classDate,
                        time: classTime,
                        attendees: []
                    });
                    document.getElementById('add-class-form').reset();
                    closeModal();
                } catch (error) {
                    console.error("Error adding class: ", error);
                    alert("Could not add class. Check console for errors.");
                }
            }
        });

        // Handle Student button clicks (Add Bundle, Delete)
        studentListEl.addEventListener('click', async (e) => {
            const target = e.target;
            if (target && target.closest('.add-bundle-btn')) {
                const studentId = target.closest('.add-bundle-btn').dataset.id;
                const studentRef = doc(db, studentsCol.path, studentId);
                try {
                    const studentDoc = await getDoc(studentRef);
                    const currentBundles = studentDoc.data().bundleClassesRemaining || 0;
                    await updateDoc(studentRef, {
                        bundleClassesRemaining: currentBundles + 10
                    });
                } catch (error) {
                    console.error("Error adding bundle:", error);
                    alert("Could not add bundle.");
                }
            }
            if (target && target.closest('.delete-student-btn')) {
                 const button = target.closest('.delete-student-btn');
                 const studentId = button.dataset.id;
                 const studentName = button.dataset.name;
                 openConfirmationModal(`This will permanently delete ${studentName}. This action cannot be undone.`, async () => {
                     try {
                        await deleteDoc(doc(db, studentsCol.path, studentId));
                     } catch (error) {
                         console.error("Error deleting student:", error);
                         alert("Could not delete student.");
                     }
                 });
            }
        });

        // Handle Class button clicks (Manage Attendance, Delete)
        classListEl.addEventListener('click', async (e) => {
            const target = e.target;

            // Manage Attendance button
            if (target && target.closest('.manage-attendance-btn')) {
                const button = target.closest('.manage-attendance-btn');
                currentClassId = button.dataset.id;
                const classDate = button.dataset.date;
                const classTime = button.dataset.time;
                attendanceModalHeader.textContent = `${classDate} at ${classTime}`;
                
                const classRef = doc(db, classesCol.path, currentClassId);
                const classDoc = await getDoc(classRef);
                const currentAttendees = classDoc.data().attendees || [];
                
                attendanceListEl.innerHTML = ''; // Clear previous list
                allStudents.forEach(student => {
                    const isAttending = currentAttendees.includes(student.id);
                    const isChecked = isAttending ? 'checked' : '';
                    const hasBundle = (student.bundleClassesRemaining || 0) > 0;
                    const bundleInfo = hasBundle ? `(${student.bundleClassesRemaining} left)` : '(No Bundle)';
                    
                    const label = document.createElement('label');
                    label.className = 'flex items-center p-2 border rounded-md hover:bg-gray-50';
                    label.innerHTML = `
                        <input type="checkbox" data-student-id="${student.id}" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${isChecked}>
                        <span class="ml-3 font-medium">${student.name}</span>
                        <span class="ml-2 text-sm text-gray-500">${bundleInfo}</span>
                    `;
                    attendanceListEl.appendChild(label);
                });

                openModal('attendance');
            }
            
            // Delete Class button
            if (target && target.closest('.delete-class-btn')) {
                const button = target.closest('.delete-class-btn');
                const classId = button.dataset.id;
                const classDate = button.dataset.date;
                 openConfirmationModal(`This will delete the class on ${classDate} and refund a class credit to all attendees. This cannot be undone.`, async () => {
                     const classRef = doc(db, classesCol.path, classId);
                     try {
                        const classDoc = await getDoc(classRef);
                        if (!classDoc.exists()) return;

                        const attendeeIds = classDoc.data().attendees || [];
                        const batch = writeBatch(db);

                        // Refund class credits
                        if (attendeeIds.length > 0) {
                            for (const studentId of attendeeIds) {
                                const studentRef = doc(db, studentsCol.path, studentId);
                                const student = allStudents.find(s => s.id === studentId);
                                if (student) {
                                    const newBundleCount = (student.bundleClassesRemaining || 0) + 1;
                                    batch.update(studentRef, { bundleClassesRemaining: newBundleCount });
                                }
                            }
                        }
                        
                        // Delete the class
                        batch.delete(classRef);
                        await batch.commit();

                     } catch (error) {
                         console.error("Error deleting class:", error);
                         alert("Could not delete class.");
                     }
                 });
            }
        });
        
        // --- Attendance Logic ---
        const attendanceListEl = document.getElementById('attendance-student-list');
        const attendanceModalHeader = document.getElementById('attendance-modal-header');
        let currentClassId = null;

        document.getElementById('save-attendance-btn').addEventListener('click', async () => {
            if (!currentClassId) return;

            const selectedCheckboxes = attendanceListEl.querySelectorAll('input[type="checkbox"]:checked');
            const newAttendeeIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.studentId);
            
            try {
                const classRef = doc(db, classesCol.path, currentClassId);
                const classDoc = await getDoc(classRef);
                const previousAttendeeIds = classDoc.data().attendees || [];
                const batch = writeBatch(db);

                batch.update(classRef, { attendees: newAttendeeIds });

                allStudents.forEach(student => {
                    const wasAttending = previousAttendeeIds.includes(student.id);
                    const isNowAttending = newAttendeeIds.includes(student.id);
                    
                    if (wasAttending === isNowAttending) return; // No change for this student

                    const studentRef = doc(db, studentsCol.path, student.id);
                    const classesRemaining = student.bundleClassesRemaining || 0;

                    if (!wasAttending && isNowAttending && classesRemaining > 0) {
                        batch.update(studentRef, { bundleClassesRemaining: classesRemaining - 1 });
                    }
                    else if (wasAttending && !isNowAttending) {
                         batch.update(studentRef, { bundleClassesRemaining: classesRemaining + 1 });
                    }
                });
                
                await batch.commit();
                closeModal();

            } catch (error) {
                console.error("Error saving attendance: ", error);
                alert("Could not save attendance.");
            }
        });

        // --- Export to CSV Logic ---
        document.getElementById('export-csv-btn').addEventListener('click', () => {
            if (allStudents.length === 0) {
                alert("No student data to export.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Student Name,Remaining Bundle Classes\r\n"; // CSV Header

            allStudents.forEach(student => {
                const row = `"${student.name}",${student.bundleClassesRemaining || 0}`;
                csvContent += row + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const formattedDate = dayjs().format('YYYY-MM-DD');
            link.setAttribute("download", `student_export_${formattedDate}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // --- Initial Load ---
        setupListeners();

    </script>
</body>
</html>
